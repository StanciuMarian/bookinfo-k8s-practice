# Build a Local Enviroment and a Prod image with Docker


We will build our image in stages and will try to keep as many things in common between the image for local development and the prod image.


```
# we start from a maven image in order to build the application 
FROM maven:3.6.3-jdk-8-slim AS builder
# we set a working directory
WORKDIR /usr/src/bookinfo-reviews
# we copy only the pom.xml because we want Docker to cache it if we don't make any changes to it
COPY pom.xml ./
# since all the layers before this RUN command came from cache, Docker will also take this layer from cache
# this command will be execute only if a layer before this one changed, so it will run only when we make changes to the pom.xml
# this will just download out dependencies
RUN mvn dependency:go-offline
# we copy only the src folder since we don't care about anything else (target folder or files generated by the IDE)
COPY src ./src
# we compile and build our artefact, skipping the tests for now :)
RUN mvn package -DskipTests
```


We continue with our `prod` image
```
# we start from a jre 8 image since is all we need to run our application
FROM openjdk:8-jre-alpine as prod
# we copy the jar file from the previous stage
COPY --from=builder /usr/src/bookinfo-reviews/target/bookinfo-reviews-*.jar bookinfo-reviews.jar
# we start our application by passing 'spring.devtools.restart.enabled=false' property, we don't want this enabled in the prod image
CMD ["java", "-jar", "-Dspring.devtools.restart.enabled=false", "bookinfo-reviews.jar"]
```

```
# for the dev-local image we actually start from the prod image, and we will just change the starting command
FROM prod as dev-local
CMD ["java", "-jar", "bookinfo-reviews.jar"]
```

```
# we need this line as the last command in the Dockerfile because we want the prod image by default
FROM prod
```

The image tree will look like this: 

```
                        maven:3.6.3-jdk-8-slim
                                   |
                                   |
                                   |            openjdk:8-alpine
                                builder --------------- |
                                                        |
                                                        |
                                                        |
                                                        prod
                                                            \
                                                             \
                                                              \ 
                                                               \
                                                            dev-local
```

Final result:
```
FROM maven:3.6.3-jdk-8-slim AS builder
WORKDIR /usr/src/bookinfo-reviews
COPY pom.xml ./
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn install -DskipTests

FROM openjdk:8-alpine as prod
COPY --from=builder /usr/src/bookinfo-reviews/target/bookinfo-reviews-*.jar bookinfo-reviews.jar
CMD ["java", "-jar", "-Dspring.devtools.restart.enabled=false", "bookinfo-reviews.jar"]

FROM prod as dev-local
CMD ["java", "-jar", "bookinfo-reviews.jar"]

FROM prod
```



To connect to the container from the IDE we have to use the remote devtools.

We need create a new `Run configuration - Java Configuration`:
We must set the main class to `org.springframework.boot.devtools.RemoteSpringApplication`  
We also must set the `Program Arguments` to `http://localhost:PORT/reviews-app` where `PORT` is the host port that is mapped to the container. 

* For Intellij
![](https://i.ibb.co/vYd1HMN/intellij.png)

* For Eclipse
![](https://i.ibb.co/jD3pRqz/eclipse1.png)
![](https://i.ibb.co/3N09N3n/eclpise2.png)
